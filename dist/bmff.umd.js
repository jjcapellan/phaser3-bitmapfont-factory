!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e||self).BMFFactory=t()}(this,function(){function e(e,t){if(!{}.hasOwnProperty.call(e,t))throw new TypeError("attempted to use private field on non-instance");return e}var t=0;function n(e){return"__private_"+t+++"_"+e}var r=[" A"," T"," Y","11","A ","AT","AV","AW","AY","Av","Aw","Ay","F,","F.","FA","L ","LT","LV","LW","LY","Ly","P ","P,","P.","PA","RT","RV","RW","RY","T ","T,","T-","T.","T:","T;","TA","TO","Ta","Tc","Te","Ti","To","Tr","Ts","Tu","Tw","Ty","V,","V-","V.","V:","V;","VA","Va","Ve","Vi","Vo","Vr","Vu","Vy","W,","W-","W.","W:","W;","WA","Wa","We","Wi","Wo","Wr","Wu","Wy","Y ","Y,","Y-","Y.","Y:","Y;","YA","Ya","Ye","Yi","Yo","Yp","Yq","Yu","Yv","ff","r,","r.","v,","v.","w,","w.","y,","y."],i=["Arial","Calibri","Helvetica","Roboto","Trebuchet MS","Verdana"],o=["Garamond","Georgia","serif","Times","Times New Roman"],a=["Consolas","Courier","Courier New","monospace"];function s(e,t){return parseInt(e.getAttribute(t),10)}var l=function(e,t,n,r,i){void 0===n&&(n=0),void 0===r&&(r=0);var o=t.cutX,a=t.cutY,l=t.source.width,u=t.source.height,c=t.sourceIndex,f={},h=e.getElementsByTagName("info")[0],d=e.getElementsByTagName("common")[0];f.font=h.getAttribute("face"),f.size=s(h,"size"),f.lineHeight=s(d,"lineHeight")+r,f.chars={};var v=e.getElementsByTagName("char"),g=void 0!==t&&t.trimmed;if(g)var m=t.height,x=t.width;for(var p=0;p<v.length;p++){var y=v[p],P=s(y,"id"),b=String.fromCharCode(P),w=s(y,"x"),B=s(y,"y"),T=s(y,"width"),O=s(y,"height");g&&(w<x&&(x=w),B<m&&(m=B)),g&&0!==m&&0!==x&&(w-=t.x,B-=t.y);var Y=(o+w)/l,j=(a+B)/u,A=(o+w+T)/l,W=(a+B+O)/u;if(f.chars[P]={x:w,y:B,width:T,height:O,centerX:Math.floor(T/2),centerY:Math.floor(O/2),xOffset:s(y,"xoffset"),yOffset:s(y,"yoffset"),xAdvance:s(y,"xadvance")+n,data:{},kerning:{},u0:Y,v0:j,u1:A,v1:W},i&&0!==T&&0!==O){var k=i.add(b,c,w,B,T,O);k&&k.setUVs(T,O,Y,j,A,W)}}var X=e.getElementsByTagName("kerning");for(p=0;p<X.length;p++){var L=X[p],V=s(L,"first"),F=s(L,"second"),H=s(L,"amount");f.chars[F].kerning[V]=H}return f};function u(e,t,n){if(!e.s){if(n instanceof f){if(!n.s)return void(n.o=u.bind(null,e,t));1&t&&(t=n.s),n=n.v}if(n&&n.then)return void n.then(u.bind(null,e,t),u.bind(null,e,2));e.s=t,e.v=n;var r=e.o;r&&r(e)}}var c=/*#__PURE__*/n("ctx"),f=/*#__PURE__*/function(){function e(){}return e.prototype.then=function(t,n){var r=new e,i=this.s;if(i){var o=1&i?t:n;if(o){try{u(r,1,o(this.v))}catch(e){u(r,2,e)}return r}return this}return this.o=function(e){try{var i=e.v;1&e.s?u(r,1,t?t(i):i):n?u(r,1,n(i)):u(r,2,i)}catch(e){u(r,2,e)}},r},e}();function h(e,t,n){var r,i,o=-1;return function a(s){try{for(;++o<e.length&&(!n||!n());)if((s=t(o))&&s.then){if(!((l=s)instanceof f&&1&l.s))return void s.then(a,i||(i=u.bind(null,r=new f,2)));s=s.v}r?u(r,1,s):r=s}catch(e){u(r||(r=new f),2,e)}var l}(),r}var d=/*#__PURE__*/n("currentPendingSteps"),v=/*#__PURE__*/n("currentTexture"),g=/*#__PURE__*/n("currentXMLs"),m=/*#__PURE__*/n("onComplete"),x=/*#__PURE__*/n("padding"),p=/*#__PURE__*/n("tasks"),y=/*#__PURE__*/n("textureWidth"),P=/*#__PURE__*/n("textureHeight"),b=/*#__PURE__*/n("totalGlyphs"),w=/*#__PURE__*/n("totalHeight"),B=/*#__PURE__*/n("totalProgress"),T=/*#__PURE__*/n("totalWidth"),O=/*#__PURE__*/n("calcBounds"),Y=/*#__PURE__*/n("calcKernings"),j=/*#__PURE__*/n("finish"),A=/*#__PURE__*/n("getKerningPairs"),W=/*#__PURE__*/n("getTextureWidth"),k=/*#__PURE__*/n("getValidFont"),X=/*#__PURE__*/n("makeGlyphs"),L=/*#__PURE__*/n("makeTexture"),V=/*#__PURE__*/n("makeXMLs"),F=/*#__PURE__*/n("step");/*#__PURE__*/
return function(){function t(t,n,s){var u=this,f=this,H=this,R=this,M=this;void 0===s&&(s={PoT:!1}),this.onProgress=void 0,this.PoT=!1,this.scene=void 0,this.defaultFonts={sansSerif:i,serif:o,monospace:a},Object.defineProperty(this,c,{writable:!0,value:void 0}),Object.defineProperty(this,d,{writable:!0,value:0}),Object.defineProperty(this,v,{writable:!0,value:null}),Object.defineProperty(this,g,{writable:!0,value:[]}),Object.defineProperty(this,m,{writable:!0,value:function(){}}),Object.defineProperty(this,x,{writable:!0,value:1}),Object.defineProperty(this,p,{writable:!0,value:[]}),Object.defineProperty(this,y,{writable:!0,value:0}),Object.defineProperty(this,P,{writable:!0,value:0}),Object.defineProperty(this,b,{writable:!0,value:0}),Object.defineProperty(this,w,{writable:!0,value:0}),Object.defineProperty(this,B,{writable:!0,value:0}),Object.defineProperty(this,T,{writable:!0,value:0}),Object.defineProperty(this,O,{writable:!0,value:function(){var t,n=e(M,p)[p],r=0,i=e(M,x)[x],o=e(M,x)[x];t=e(M,W)[W](e(M,b)[b],e(M,w)[w],e(M,T)[T]);for(var a=[],s=0;s<n.length;s++)a.push.apply(a,n[s].glyphs);a.sort(function(e,t){return t.xmlHeight-e.xmlHeight});var l=a[0],u=l.xmlHeight+e(M,x)[x];a.forEach(function(n){n.xmlX=o,n.xmlY=i,(o=n.xmlX+n.xmlWidth+e(M,x)[x])>t&&(n.xmlX=e(M,x)[x],n.xmlY=u+i,l=n,o=n.xmlX+n.xmlWidth+e(M,x)[x],i+=u,u=n.xmlHeight+e(M,x)[x]),n.printX=n.xmlX+n.actualBoundingBoxLeft,n.printY=n.xmlY+n.actualBoundingBoxAscent}),r=l.xmlY+l.xmlHeight+e(M,x)[x],M.PoT&&(r=Phaser.Math.Pow2.GetNext(r)),e(M,y)[y]=t,e(M,P)[P]=r}}),Object.defineProperty(this,Y,{writable:!0,value:function(){try{var t=e(u,p)[p],n=e(u,c)[c];return Promise.resolve(h(t,function(r){var i=t[r];if(i.getKernings){var o=i.kernings,a=i.chars,s=i.glyphs,l=e(u,A)[A](i);n.font=i.font;for(var c=0;c<l.length;c++){var f=l[c].split(""),h=s[a.indexOf(f[0])],d=s[a.indexOf(f[1])],v=h.xmlWidth+d.xmlWidth,g=n.measureText(l[c]),m=Math.ceil(g.actualBoundingBoxRight+g.actualBoundingBoxLeft-v);0!=m&&o.push({first:h.id,second:d.id,amount:m})}var x=function(){if(u.onProgress){e(u,B)[B]+=1/e(u,p)[p].length*.5;var t=u;return Promise.resolve(new Promise(function(n){t.onProgress(e(t,B)[B]),t.scene.events.once("preupdate",n)})).then(function(){})}}();return x&&x.then?x.then(function(){}):void 0}}))}catch(e){return Promise.reject(e)}}}),Object.defineProperty(this,j,{writable:!0,value:function(){for(var t=e(M,v)[v],n=e(M,g)[g],r=e(M,p)[p][0].key,i=M.scene.textures.getFrame(r),o=0;o<n.length;o++){var a=l(n[o],i,0,0,t);M.scene.cache.bitmapFont.add(e(M,p)[p][o].key,{data:a,texture:r,frame:null})}e(M,v)[v]=null,e(M,g)[g]=[],e(M,p)[p]=[],e(M,m)[m]()}}),Object.defineProperty(this,A,{writable:!0,value:function(e){for(var t=[],n=0;n<r.length;n++){var i=r[n].split("");-1!=e.chars.indexOf(i[0])&&-1!=e.chars.indexOf(i[1])&&t.push(r[n])}return t}}),Object.defineProperty(this,W,{writable:!0,value:function(t,n,r){var i=Math.max(n/t,r/t),o=Math.ceil(Math.sqrt(i*i*t));return M.PoT?Phaser.Math.Pow2.GetNext(o):o+2*e(M,x)[x]}}),Object.defineProperty(this,k,{writable:!0,value:function(e){for(var t="",n=0;n<e.length;n++)if(M.check(e[n])){t=e[n];break}return t}}),Object.defineProperty(this,X,{writable:!0,value:function(){try{var t=e(f,p)[p],n=e(f,c)[c];return Promise.resolve(h(t,function(r){var i=t[r],o=i.chars,a=o.length;e(f,b)[b]+=a,n.font=i.font;for(var s=0;s<a;s++){var l=o[s],u={actualBoundingBoxAscent:0,actualBoundingBoxLeft:0,id:l.charCodeAt(0),letter:l,printX:0,printY:0,xmlX:0,xmlY:0,xmlXoffset:0,xmlYoffset:0,xmlHeight:0,xmlWidth:0,xmlXadvance:0},c=n.measureText(l);u.xmlXoffset=-c.actualBoundingBoxLeft,u.xmlYoffset=c.actualBoundingBoxDescent,u.xmlWidth=c.actualBoundingBoxRight+c.actualBoundingBoxLeft,u.xmlHeight=c.actualBoundingBoxDescent+c.actualBoundingBoxAscent,u.xmlXadvance=c.width,u.actualBoundingBoxAscent=c.actualBoundingBoxAscent,u.actualBoundingBoxLeft=c.actualBoundingBoxLeft,i.glyphs.push(u),e(f,w)[w]+=u.xmlHeight+e(f,x)[x],e(f,T)[T]+=u.xmlWidth+e(f,x)[x]}var h=function(){if(f.onProgress){e(f,B)[B]+=1/e(f,p)[p].length*.5;var t=f;return Promise.resolve(new Promise(function(n){t.onProgress(e(t,B)[B]),t.scene.events.once("preupdate",n)})).then(function(){})}}();if(h&&h.then)return h.then(function(){})}))}catch(e){return Promise.reject(e)}}}),Object.defineProperty(this,L,{writable:!0,value:function(){try{return Promise.resolve(function(e,t,n,r){try{var i=t[0].key,o=document.createElement("canvas"),a=o.getContext("2d",{willReadFrequently:!0});o.width=n,o.height=r;for(var s=0;s<t.length;s++){var l=t[s],u=l.glyphs;a.font=l.font,a.fillStyle=l.style.color?l.style.color:"white";for(var c=0;c<u.length;c++){var f=u[c];a.fillText(f.letter,f.printX,f.printY)}}return Promise.resolve(new Promise(function(t){o.toBlob(function(n){var r=document.createElement("img"),o=URL.createObjectURL(n);r.onload=function(){e.textures.addImage(i,r);var n=e.textures.get(i);URL.revokeObjectURL(o),t(n)},r.src=o},"image/png")}))}catch(e){return Promise.reject(e)}}(H.scene,e(H,p)[p],e(H,y)[y],e(H,P)[P])).then(function(t){e(H,v)[v]=t,e(H,F)[F](null)})}catch(e){return Promise.reject(e)}}}),Object.defineProperty(this,V,{writable:!0,value:function(){try{return e(R,g)[g]=function(e){for(var t=[],n=0;n<e.length;n++){for(var r=e[n],i=r.chars.length,o=r.fontFamily,a=r.style.fontSize.replace("px",""),s=r.glyphs,l=Number.parseInt(a),u='<?xml version="1.0"?><font><info face="'+o+'" size="'+a+'"></info><common lineHeight="'+a+'"></common><chars count="'+i+'">',c="",f=0;f<i;f++){var h=s[f];c+='<char id="'+h.id+'" x="'+h.xmlX+'" y="'+h.xmlY+'" width="'+h.xmlWidth+'" height="'+h.xmlHeight+'" xoffset="'+h.xmlXoffset+'" yoffset="'+(l-(h.printY-h.xmlY))+'" xadvance="'+h.xmlXadvance+'"/>'}c+="</chars>";var d="";if(r.getKernings){var v=r.kernings.length,g=r.kernings;d+='<kernings count="'+v+'">';for(var m=0;m<v;m++){var x=g[m];d+='<kerning first="'+x.first+'" second="'+x.second+'" amount="'+x.amount+'" />'}d+="</kernings>"}var p=u+c+d+"</font>",y=(new DOMParser).parseFromString(p,"application/xml");t.push(y)}return t}(e(R,p)[p]),e(R,F)[F](null),Promise.resolve()}catch(e){return Promise.reject(e)}}}),Object.defineProperty(this,F,{writable:!0,value:function(t){e(M,d)[d]-=1,0==e(M,d)[d]&&e(M,j)[j]()}}),this.scene=t,this.PoT=s.PoT,this.onProgress=s.onProgress,e(this,m)[m]=n,e(this,c)[c]=document.createElement("canvas").getContext("2d")}var n=t.prototype;return n.check=function(t){var n=e(this,c)[c];n.font="12px default";var r=n.measureText("0");n.font="12px "+t;var i=n.measureText("0");return r.actualBoundingBoxAscent!=i.actualBoundingBoxAscent&&r.actualBoundingBoxRight!=i.actualBoundingBoxRight},n.exec=function(){try{var t=this;return e(t,b)[b]=0,e(t,w)[w]=0,e(t,T)[T]=0,Promise.resolve(e(t,X)[X]()).then(function(){return e(t,O)[O](),Promise.resolve(e(t,Y)[Y]()).then(function(){e(t,d)[d]=2,e(t,L)[L](),e(t,V)[V]()})})}catch(e){return Promise.reject(e)}},n.make=function(t,n,r,i,o){var a;void 0===o&&(o=!0),null==i.fontSize&&(i.fontSize="32px"),a="string"==typeof n?n:e(this,k)[k](n);var s="";s+=i.fontStyle?i.fontStyle+" ":"",s+=i.fontSize+" ";var l={chars:r,font:s+='"'+a+'"',fontFamily:a,glyphs:[],getKernings:o,kernings:[],key:t,style:i};l.style.fontFamily=l.fontFamily,e(this,p)[p].push(l)},t}()});
